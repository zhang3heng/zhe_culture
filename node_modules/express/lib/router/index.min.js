var Route=require("./route");var Layer=require("./layer");var methods=require("methods");var debug=require("debug")("express:router");var parseUrl=require("parseurl");var proto=module.exports=function(b){b=b||{};function a(e,c,d){a.handle(e,c,d)}a.__proto__=proto;a.params={};a._params=[];a.caseSensitive=b.caseSensitive;a.strict=b.strict;a.stack=[];return a};proto.param=function(c,e){if("function"==typeof c){this._params.push(c);return}var f=this._params;var a=f.length;var b;if(c[0]===":"){c=c.substr(1)}for(var d=0;d<a;++d){if(b=f[d](c,e)){e=b}}if("function"!=typeof e){throw new Error("invalid param() call for "+c+", got "+e)}(this.params[c]=this.params[c]||[]).push(e);return this};proto.handle=function(l,i,e){var n=this;debug("dispatching %s %s",l.method,l.url);var b=l.method.toLowerCase();var p=1+l.url.indexOf("?");var j=p?p-1:l.url.length;var d=1+l.url.substr(0,j).indexOf("://");var a=d?l.url.substr(0,l.url.indexOf("/",2+d)):"";var m=0;var h="";var f=false;var o=[];var k=n.stack;if(b==="options"){var c=e;e=function(r){if(r||o.length===0){return c(r)}var q=o.join(",");return i.set("Allow",q).send(q)}}(function g(t){if(t==="route"){t=undefined}var s=k[m++];if(!s){return e(t)}if(f){l.url=l.url.substr(1);f=false}l.url=a+h+l.url.substr(a.length);l.originalUrl=l.originalUrl||l.url;h="";try{var u=parseUrl(l).pathname;if(undefined==u){u="/"}if(!s.match(u)){return g(t)}var q=s.route;if(q){if(t){return g(t)}l.route=q;if(b==="options"&&!q.methods.options){o.push.apply(o,q._options())}}l.params=s.params;return n.process_params(s,l,i,function(v){if(v){return g(v)}if(q){return s.handle(l,i,g)}r()});function r(){var w=u[s.path.length];if(w&&"/"!=w&&"."!=w){return g(t)}debug("trim prefix (%s) from url %s",h,l.url);h=s.path;l.url=a+l.url.substr(a.length+h.length);if(!d&&"/"!=l.url[0]){l.url="/"+l.url;f=true}debug("%s %s : %s",s.handle.name||"anonymous",s.path,l.originalUrl);var v=s.handle.length;if(t){if(v===4){s.handle(t,l,i,g)}else{g(t)}}else{if(v<4){s.handle(l,i,g)}else{g(t)}}}}catch(t){g(t)}})()};proto.process_params=function(j,g,f,d){var b=this.params;var m=j.keys;if(!m||m.length===0){return d()}var e=0;var n=0;var l;var k;var h;function a(i){if(i){return d(i)}if(e>=m.length){return d()}n=0;l=m[e++];k=l&&g.params[l.name];h=l&&b[l.name];try{if(h&&undefined!==k){return c()}else{if(l){return a()}}}catch(i){return d(i)}d()}function c(o){var i=h[n++];if(o||!i){return a(o)}i(g,f,c,k,l.name)}a()};proto.use=function(a,d){if("string"!=typeof a){d=a;a="/"}if(typeof d!=="function"){var c={}.toString.call(d);var e="Router.use() requires callback functions but got a "+c;throw new Error(e)}if("/"==a[a.length-1]){a=a.slice(0,-1)}var b=new Layer(a,{sensitive:this.caseSensitive,strict:this.strict,end:false},d);debug("use %s %s",a||"/",d.name||"anonymous");this.stack.push(b);return this};proto.route=function(c){var a=new Route(c);var b=new Layer(c,{sensitive:this.caseSensitive,strict:this.strict,end:true},a.dispatch.bind(a));b.route=a;this.stack.push(b);return a};methods.concat("all").forEach(function(a){proto[a]=function(c){var b=this.route(c);b[a].apply(b,[].slice.call(arguments,1));return this}});