/*
 * Connect - compress
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var zlib=require("zlib");var bytes=require("bytes");var Negotiator=require("negotiator");var compressible=require("compressible");exports.methods={gzip:zlib.createGzip,deflate:zlib.createDeflate};exports.filter=function(b,a){return compressible(a.getHeader("Content-Type"))};module.exports=function compress(c){c=c||{};var d=c.filter||exports.filter;var b;if(false===c.threshold||0===c.threshold){b=0}else{if("string"===typeof c.threshold){b=bytes(c.threshold)}else{b=c.threshold||1024}}return function a(j,i,h){var e=j.headers["accept-encoding"],l=i.writeHead,m=i.write,g=i.end,f=true,k;j.on("close",function(){i.write=i.end=function(){}});i.flush=noop;i.write=function(n,p){if(!this.headerSent){var o=i.getHeader("content-length");if(!isNaN(o)&&o<b){f=false}this._implicitHeader()}return k?k.write(new Buffer(n,p)):m.call(i,n,p)};i.end=function(n,o){if(n){if(!this.headerSent&&getSize(n)<b){f=false}this.write(n,o)}else{if(!this.headerSent){f=false}}return k?k.end():g.call(i)};i.writeHead=function(){if(!d(j,i)){return l.apply(i,arguments)}var n=i.getHeader("Vary");if(!n){i.setHeader("Vary","Accept-Encoding")}else{if(!~n.indexOf("Accept-Encoding")){i.setHeader("Vary",n+", Accept-Encoding")}}if(!f){return l.apply(i,arguments)}var o=i.getHeader("Content-Encoding")||"identity";if("identity"!=o){return l.apply(i,arguments)}if(!e){return l.apply(i,arguments)}if("HEAD"==j.method){return l.apply(i,arguments)}var p=new Negotiator(j).preferredEncoding(["gzip","deflate","identity"]);if(p==="identity"){return l.apply(i,arguments)}k=exports.methods[p](c);i.flush=function(){k.flush()};i.setHeader("Content-Encoding",p);i.removeHeader("Content-Length");k.on("data",function(q){m.call(i,q)});k.on("end",function(){g.call(i)});k.on("drain",function(){i.emit("drain")});l.apply(i,arguments)};h()}};function getSize(a){return Buffer.isBuffer(a)?a.length:Buffer.byteLength(a)}function noop(){};