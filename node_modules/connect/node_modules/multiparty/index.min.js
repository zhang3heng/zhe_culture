exports.Form=Form;var stream=require("readable-stream"),util=require("util"),fs=require("fs"),crypto=require("crypto"),path=require("path"),os=require("os"),StringDecoder=require("string_decoder").StringDecoder,StreamCounter=require("stream-counter");var START=0,START_BOUNDARY=1,HEADER_FIELD_START=2,HEADER_FIELD=3,HEADER_VALUE_START=4,HEADER_VALUE=5,HEADER_VALUE_ALMOST_DONE=6,HEADERS_ALMOST_DONE=7,PART_DATA_START=8,PART_DATA=9,PART_END=10,END=11,LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122;var CONTENT_TYPE_RE=/^multipart\/(form-data|related);\s*boundary=(?:"([^"]+)"|([^;]+))$/i;var FILE_EXT_RE=/(\.[_\-a-zA-Z0-9]{0,16}).*/;var LAST_BOUNDARY_SUFFIX_LEN=4;util.inherits(Form,stream.Writable);function Form(b){var a=this;stream.Writable.call(a);b=b||{};a.error=null;a.finished=false;a.autoFields=!!b.autoFields;a.autoFiles=!!b.autoFields;a.maxFields=b.maxFields||1000;a.maxFieldsSize=b.maxFieldsSize||2*1024*1024;a.uploadDir=b.uploadDir||os.tmpDir();a.encoding=b.encoding||"utf8";a.hash=b.hash||false;a.bytesReceived=0;a.bytesExpected=null;a.openedFiles=[];a.totalFieldSize=0;a.totalFieldCount=0;a.flushing=0;a.backpressure=false;a.writeCbs=[];if(b.boundary){setUpParser(a,b.boundary)}a.on("newListener",function(c){if(c==="file"){a.autoFiles=true}else{if(c==="field"){a.autoFields=true}}})}Form.prototype.parse=function(g,d){var k=this;if(d){k.autoFields=true;k.autoFiles=true}k.handleError=b;k.bytesExpected=getBytesExpected(g.headers);g.on("error",b);g.on("aborted",e);var j=g.headers["content-type"];if(!j){b(new Error("missing content-type header"));return}var c=j.match(CONTENT_TYPE_RE);if(!c){b(new Error("unrecognized content-type: "+j));return}var a=c[2]||c[3];setUpParser(k,a);g.pipe(k);if(d){var l={};var i={};var f=[];var h=[];k.on("error",function(m){d(m)});k.on("field",function(m,n){l[m]=n;f.push({name:m,value:n})});k.on("file",function(m,n){i[m]=n;h.push(n)});k.on("close",function(){d(null,l,i,f,h)})}function e(){k.emit("aborted");b(new Error("Request aborted"))}function b(m){var n=!k.error;if(n){k.error=m;g.removeListener("aborted",e);if(g.unpipe){g.unpipe(k)}}k.openedFiles.forEach(function(o){o.ws.destroy();fs.unlink(o.path,function(p){})});k.openedFiles=[];if(n){k.emit("error",m)}}};Form.prototype._write=function(m,a,l){var k=this,p=0,q=m.length,h=k.index,g=k.index,b=k.state,o=k.lookbehind,r=k.boundary,n=k.boundaryChars,s=k.boundary.length,e=s-1,f=m.length,t,j;for(p=0;p<q;p++){t=m[p];switch(b){case START:g=0;b=START_BOUNDARY;case START_BOUNDARY:if(g===s-2){if(t!==CR){return k.handleError(new Error("Expected CR Received "+t))}g++;break}else{if(g===s-1){if(t!==LF){return k.handleError(new Error("Expected LF Received "+t))}g=0;k.onParsePartBegin();b=HEADER_FIELD_START;break}}if(t!==r[g+2]){g=-2}if(t===r[g+2]){g++}break;case HEADER_FIELD_START:b=HEADER_FIELD;k.headerFieldMark=p;g=0;case HEADER_FIELD:if(t===CR){k.headerFieldMark=null;b=HEADERS_ALMOST_DONE;break}g++;if(t===HYPHEN){break}if(t===COLON){if(g===1){k.handleError(new Error("Empty header field"));return}k.onParseHeaderField(m.slice(k.headerFieldMark,p));k.headerFieldMark=null;b=HEADER_VALUE_START;break}j=lower(t);if(j<A||j>Z){k.handleError(new Error("Expected alphabetic character, received "+t));return}break;case HEADER_VALUE_START:if(t===SPACE){break}k.headerValueMark=p;b=HEADER_VALUE;case HEADER_VALUE:if(t===CR){k.onParseHeaderValue(m.slice(k.headerValueMark,p));k.headerValueMark=null;k.onParseHeaderEnd();b=HEADER_VALUE_ALMOST_DONE}break;case HEADER_VALUE_ALMOST_DONE:if(t!==LF){return k.handleError(new Error("Expected LF Received "+t))}b=HEADER_FIELD_START;break;case HEADERS_ALMOST_DONE:if(t!==LF){return k.handleError(new Error("Expected LF Received "+t))}var d=k.onParseHeadersEnd(p+1);if(d){return k.handleError(d)}b=PART_DATA_START;break;case PART_DATA_START:b=PART_DATA;k.partDataMark=p;case PART_DATA:h=g;if(g===0){p+=e;while(p<f&&!(m[p] in n)){p+=s}p-=e;t=m[p]}if(g<s){if(r[g]===t){if(g===0){k.onParsePartData(m.slice(k.partDataMark,p));k.partDataMark=null}g++}else{g=0}}else{if(g===s){g++;if(t===CR){k.partBoundaryFlag=true}else{if(t===HYPHEN){k.lastBoundaryFlag=true}else{g=0}}}else{if(g-1===s){if(k.partBoundaryFlag){g=0;if(t===LF){k.partBoundaryFlag=false;k.onParsePartEnd();k.onParsePartBegin();b=HEADER_FIELD_START;break}}else{if(k.lastBoundaryFlag){if(t===HYPHEN){k.onParsePartEnd();k.end();b=END}else{g=0}}else{g=0}}}}}if(g>0){o[g-1]=t}else{if(h>0){k.onParsePartData(o.slice(0,h));h=0;k.partDataMark=p;p--}}break;case END:break;default:k.handleError(new Error("Parser has invalid state."));return}}if(k.headerFieldMark!=null){k.onParseHeaderField(m.slice(k.headerFieldMark));k.headerFieldMark=0}if(k.headerValueMark!=null){k.onParseHeaderValue(m.slice(k.headerValueMark));k.headerValueMark=0}if(k.partDataMark!=null){k.onParsePartData(m.slice(k.partDataMark));k.partDataMark=0}k.index=g;k.state=b;k.bytesReceived+=m.length;k.emit("progress",k.bytesReceived,k.bytesExpected);if(k.backpressure){k.writeCbs.push(l)}else{l()}};Form.prototype.onParsePartBegin=function(){clearPartVars(this)};Form.prototype.onParseHeaderField=function(a){this.headerField+=this.headerFieldDecoder.write(a)};Form.prototype.onParseHeaderValue=function(a){this.headerValue+=this.headerValueDecoder.write(a)};Form.prototype.onParseHeaderEnd=function(){this.headerField=this.headerField.toLowerCase();this.partHeaders[this.headerField]=this.headerValue;var a;if(this.headerField==="content-disposition"){if(a=this.headerValue.match(/\bname="([^"]+)"/i)){this.partName=a[1]}this.partFilename=parseFilename(this.headerValue)}else{if(this.headerField==="content-transfer-encoding"){this.partTransferEncoding=this.headerValue.toLowerCase()}}this.headerFieldDecoder=new StringDecoder(this.encoding);this.headerField="";this.headerValueDecoder=new StringDecoder(this.encoding);this.headerValue=""};Form.prototype.onParsePartData=function(a){if(this.partTransferEncoding==="base64"){this.backpressure=!this.destStream.write(a.toString("ascii"),"base64")}else{this.backpressure=!this.destStream.write(a)}};Form.prototype.onParsePartEnd=function(){if(this.destStream){flushWriteCbs(this);var a=this.destStream;process.nextTick(function(){a.end()})}clearPartVars(this)};Form.prototype.onParseHeadersEnd=function(c){var a=this;switch(a.partTransferEncoding){case"binary":case"7bit":case"8bit":a.partTransferEncoding="binary";break;case"base64":break;default:return new Error("unknown transfer-encoding: "+a.partTransferEncoding)}a.totalFieldCount+=1;if(a.totalFieldCount>=a.maxFields){return new Error("maxFields "+a.maxFields+" exceeded.")}a.destStream=new stream.PassThrough();a.destStream.on("drain",function(){flushWriteCbs(a)});a.destStream.headers=a.partHeaders;a.destStream.name=a.partName;a.destStream.filename=a.partFilename;a.destStream.byteOffset=a.bytesReceived+c;var b=a.destStream.headers["content-length"];a.destStream.byteCount=b?parseInt(b,10):(a.bytesExpected-a.destStream.byteOffset-a.boundary.length-LAST_BOUNDARY_SUFFIX_LEN);a.emit("part",a.destStream);if(a.destStream.filename==null&&a.autoFields){handleField(a,a.destStream)}else{if(a.destStream.filename!=null&&a.autoFiles){handleFile(a,a.destStream)}}};function flushWriteCbs(a){a.writeCbs.forEach(function(b){process.nextTick(b)});a.writeCbs=[];a.backpressure=false}function getBytesExpected(b){var a=b["content-length"];if(a){return parseInt(a,10)}else{if(b["transfer-encoding"]==null){return 0}else{return null}}}function beginFlush(a){a.flushing+=1}function endFlush(a){a.flushing-=1;maybeClose(a)}function maybeClose(a){if(!a.flushing&&a.finished&&!a.error){a.emit("close")}}function handleFile(c,f){beginFlush(c);var d={fieldName:f.name,originalFilename:f.filename,path:uploadPath(c.uploadDir,f.filename),headers:f.headers,};d.ws=fs.createWriteStream(d.path);c.openedFiles.push(d);f.pipe(d.ws);var a=new StreamCounter();f.pipe(a);var b,e=null;if(c.hash){b=stream.Writable();e=crypto.createHash(c.hash);b._write=function(g,h,i){e.update(g);i()};f.pipe(b)}d.ws.on("error",function(g){if(!c.error){c.handleError(g)}});d.ws.on("close",function(){if(e){d.hash=e.digest("hex")}d.size=a.bytes;c.emit("file",f.name,d);endFlush(c)})}function handleField(b,a){var c="";var d=new StringDecoder(b.encoding);beginFlush(b);a.on("readable",function(){var e=a.read();if(!e){return}b.totalFieldSize+=e.length;if(b.totalFieldSize>b.maxFieldsSize){b.handleError(new Error("maxFieldsSize "+b.maxFieldsSize+" exceeded"));return}c+=d.write(e)});a.on("end",function(){b.emit("field",a.name,c);endFlush(b)})}function clearPartVars(a){a.partHeaders={};a.partName=null;a.partFilename=null;a.partTransferEncoding="binary";a.destStream=null;a.headerFieldDecoder=new StringDecoder(a.encoding);a.headerField="";a.headerValueDecoder=new StringDecoder(a.encoding);a.headerValue=""}function setUpParser(a,c){a.boundary=new Buffer(c.length+4);a.boundary.write("\r\n--",0,c.length+4,"ascii");a.boundary.write(c,4,c.length,"ascii");a.lookbehind=new Buffer(a.boundary.length+8);a.state=START;a.boundaryChars={};for(var b=0;b<a.boundary.length;b++){a.boundaryChars[a.boundary[b]]=true}a.index=null;a.partBoundaryFlag=false;a.lastBoundaryFlag=false;a.on("finish",function(){if((a.state===HEADER_FIELD_START&&a.index===0)||(a.state===PART_DATA&&a.index===a.boundary.length)){a.onParsePartEnd()}else{if(a.state!==END){a.handleError(new Error("stream ended unexpectedly"))}}a.finished=true;maybeClose(a)})}function uploadPath(d,a){var c=path.extname(a).replace(FILE_EXT_RE,"$1");var b=process.pid+"-"+(Math.random()*4294967296+1).toString(36)+c;return path.join(d,b)}function parseFilename(c){var a=c.match(/\bfilename="(.*?)"($|; )/i);if(!a){return}var b=a[1].substr(a[1].lastIndexOf("\\")+1);b=b.replace(/%22/g,'"');b=b.replace(/&#([\d]{4});/g,function(d,e){return String.fromCharCode(e)});return b}function lower(a){return a|32};