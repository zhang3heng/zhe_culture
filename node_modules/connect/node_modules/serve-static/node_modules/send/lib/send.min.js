var debug=require("debug")("send"),parseRange=require("range-parser"),Stream=require("stream"),mime=require("mime"),fresh=require("fresh"),path=require("path"),http=require("http"),fs=require("fs"),basename=path.basename,normalize=path.normalize,join=path.join,utils=require("./utils");exports=module.exports=send;exports.mime=mime;function send(b,c,a){return new SendStream(b,c,a)}function SendStream(c,d,b){var a=this;this.req=c;this.path=d;this.options=b||{};this.maxage(0);this.hidden(false);this.index("index.html")}SendStream.prototype.__proto__=Stream.prototype;SendStream.prototype.hidden=function(a){debug("hidden %s",a);this._hidden=a;return this};SendStream.prototype.index=function(a){debug("index %s",a);this._index=a;return this};SendStream.prototype.root=SendStream.prototype.from=function(a){this._root=normalize(a);return this};SendStream.prototype.maxage=function(a){if(Infinity==a){a=60*60*24*365*1000}debug("max-age %d",a);this._maxage=a;return this};SendStream.prototype.error=function(a,c){var b=this.res;var d=http.STATUS_CODES[a];c=c||new Error(d);c.status=a;if(this.listeners("error").length){return this.emit("error",c)}b.statusCode=c.status;b.end(d)};SendStream.prototype.isMalicious=function(){return !this._root&&~this.path.indexOf("..")};SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]};SendStream.prototype.hasLeadingDot=function(){return"."==basename(this.path)[0]};SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]};SendStream.prototype.removeContentHeaderFields=function(){var a=this.res;Object.keys(a._headers).forEach(function(b){if(0==b.indexOf("content")){a.removeHeader(b)}})};SendStream.prototype.notModified=function(){var a=this.res;debug("not modified");this.removeContentHeaderFields();a.statusCode=304;a.end()};SendStream.prototype.isCachable=function(){var a=this.res;return(a.statusCode>=200&&a.statusCode<300)||304==a.statusCode};SendStream.prototype.onStatError=function(b){var a=["ENOENT","ENAMETOOLONG","ENOTDIR"];if(~a.indexOf(b.code)){return this.error(404,b)}this.error(500,b)};SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)};SendStream.prototype.redirect=function(b){if(this.listeners("directory").length){return this.emit("directory")}var a=this.res;b+="/";a.statusCode=301;a.setHeader("Location",b);a.end("Redirecting to "+utils.escape(b))};SendStream.prototype.pipe=function(d){var b=this,c=arguments,e=this.path,a=this._root;this.res=d;e=utils.decode(e);if(-1==e){return this.error(400)}if(~e.indexOf("\0")){return this.error(400)}if(a){e=normalize(join(this._root,e))}if(this.isMalicious()){return this.error(403)}if(a&&0!=e.indexOf(a)){return this.error(403)}if(!this._hidden&&this.hasLeadingDot()){return this.error(404)}if(this._index&&this.hasTrailingSlash()){e+=this._index}debug('stat "%s"',e);fs.stat(e,function(g,f){if(g){return b.onStatError(g)}if(f.isDirectory()){return b.redirect(b.path)}b.emit("file",e,f);b.send(e,f)});return d};SendStream.prototype.send=function(h,c){var i=this.options;var d=c.size;var e=this.res;var f=this.req;var a=f.headers.range;var b=i.start||0;this.setHeader(c);this.type(h);if(this.isConditionalGET()&&this.isCachable()&&this.isFresh()){return this.notModified()}d=Math.max(0,d-b);if(i.end!==undefined){var g=i.end-b+1;if(d>g){d=g}}if(a){a=parseRange(d,a);if(-1==a){e.setHeader("Content-Range","bytes */"+c.size);return this.error(416)}if(-2!=a){i.start=b+a[0].start;i.end=b+a[0].end;e.statusCode=206;e.setHeader("Content-Range","bytes "+a[0].start+"-"+a[0].end+"/"+d);d=i.end-i.start+1}}e.setHeader("Content-Length",d);if("HEAD"==f.method){return e.end()}this.stream(h,i)};SendStream.prototype.stream=function(e,b){var a=this;var c=this.res;var d=this.req;var f=fs.createReadStream(e,b);this.emit("stream",f);f.pipe(c);d.on("close",f.destroy.bind(f));f.on("error",function(g){if(c._header){console.error(g.stack);d.destroy();return}g.status=500;a.emit("error",g)});f.on("end",function(){a.emit("end")})};SendStream.prototype.type=function(c){var a=this.res;if(a.getHeader("Content-Type")){return}var b=mime.lookup(c);var d=mime.charsets.lookup(b);debug("content-type %s",b);a.setHeader("Content-Type",b+(d?"; charset="+d:""))};SendStream.prototype.setHeader=function(b){var a=this.res;if(!a.getHeader("Accept-Ranges")){a.setHeader("Accept-Ranges","bytes")}if(!a.getHeader("ETag")){a.setHeader("ETag",utils.etag(b))}if(!a.getHeader("Date")){a.setHeader("Date",new Date().toUTCString())}if(!a.getHeader("Cache-Control")){a.setHeader("Cache-Control","public, max-age="+(this._maxage/1000))}if(!a.getHeader("Last-Modified")){a.setHeader("Last-Modified",b.mtime.toUTCString())}};