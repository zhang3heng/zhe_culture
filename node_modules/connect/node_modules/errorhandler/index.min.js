/*
 * Connect - errorHandler
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var fs;try{fs=require("graceful-fs")}catch(_){fs=require("fs")}var env=process.env.NODE_ENV||"development";exports=module.exports=function errorHandler(){return function a(h,g,e,f){if(h.status){e.statusCode=h.status}if(e.statusCode<400){e.statusCode=500}if("test"!=env){console.error(h.stack)}var d=g.headers.accept||"";if(~d.indexOf("html")){fs.readFile(__dirname+"/public/style.css","utf8",function(k,j){fs.readFile(__dirname+"/public/error.html","utf8",function(n,m){var l=(h.stack||"").split("\n").slice(1).map(function(o){return"<li>"+o+"</li>"}).join("");m=m.replace("{style}",j).replace("{stack}",l).replace("{title}",exports.title).replace("{statusCode}",e.statusCode).replace(/\{error\}/g,escapeHTML(h.toString().replace(/\n/g,"<br/>")));e.setHeader("Content-Type","text/html; charset=utf-8");e.end(m)})})}else{if(~d.indexOf("json")){var b={message:h.message,stack:h.stack};for(var i in h){b[i]=h[i]}var c=JSON.stringify({error:b});e.setHeader("Content-Type","application/json");e.end(c)}else{e.setHeader("Content-Type","text/plain");e.end(h.stack)}}}};exports.title="Connect";function escapeHTML(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};