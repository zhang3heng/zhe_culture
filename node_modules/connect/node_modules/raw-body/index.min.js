var StringDecoder=require("string_decoder").StringDecoder;var bytes=require("bytes");module.exports=function(l,m,j){if(typeof m==="function"){j=m;m={}}else{if(!m){m={}}}var h=null;if(typeof m.limit==="number"){h=m.limit}if(typeof m.limit==="string"){h=bytes(m.limit)}var e=null;if(m.length!=null&&!isNaN(m.length)){e=parseInt(m.length,10)}if(h!==null&&e!==null&&e>h){if(typeof l.pause==="function"){l.pause()}process.nextTick(function(){var n=makeError("request entity too large","entity.too.large");n.status=n.statusCode=413;n.length=n.expected=e;n.limit=h;j(n)});return b}var c=l._readableState;if(c&&c.encoding!=null){if(typeof l.pause==="function"){l.pause()}process.nextTick(function(){var n=makeError("stream encoding should not be set","stream.encoding.set");n.status=n.statusCode=500;j(n)});return b}var k=0;var g=m.encoding?new StringDecoder(m.encoding===true?"utf8":m.encoding):null;var i=g?"":[];l.on("data",f);l.once("end",a);l.once("error",a);l.once("close",d);return b;function b(n){j=n}function f(n){k+=n.length;g?i+=g.write(n):i.push(n);if(h!==null&&k>h){if(typeof l.pause==="function"){l.pause()}var o=makeError("request entity too large","entity.too.large");o.status=o.statusCode=413;o.received=k;o.limit=h;j(o);d()}}function a(n){if(n){if(typeof l.pause==="function"){l.pause()}j(n)}else{if(e!==null&&k!==e){n=makeError("request size did not match content length","request.size.invalid");n.status=n.statusCode=400;n.received=k;n.length=n.expected=e;j(n)}else{j(null,g?i+endStringDecoder(g):Buffer.concat(i))}}d()}function d(){k=i=null;l.removeListener("data",f);l.removeListener("end",a);l.removeListener("error",a);l.removeListener("close",d)}};function makeError(c,b){var a=new Error();a.message=c;Object.defineProperty(a,"type",{value:b,enumerable:true,writable:true,configurable:true});return a}function endStringDecoder(e){if(e.end){return e.end()}var c="";if(e.charReceived){var d=e.charReceived;var b=e.charBuffer;var a=e.encoding;c+=b.slice(0,d).toString(a)}return c};