/*
 * Connect - session
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var uid=require("uid2"),crc32=require("buffer-crc32"),parse=require("url").parse,signature=require("cookie-signature"),debug=require("debug")("session");var Session=require("./session/session"),MemoryStore=require("./session/memory"),Cookie=require("./session/cookie"),Store=require("./session/store");var env=process.env.NODE_ENV;exports=module.exports=session;exports.Store=Store;exports.Cookie=Cookie;exports.Session=Session;exports.MemoryStore=MemoryStore;var warning="Warning: connect.session() MemoryStore is not\ndesigned for a production environment, as it will leak\nmemory, and will not scale past a single process.";function session(c){var c=c||{},e=c.key||"connect.sid",b=c.store||new MemoryStore,d=c.cookie||{},f=c.proxy,h=true,a=c.rolling||false;if("production"==env&&b instanceof MemoryStore){console.warn(warning)}b.generate=function(i){i.sessionID=uid(24);i.session=new Session(i);i.session.cookie=new Cookie(d)};b.on("disconnect",function(){h=false});b.on("connect",function(){h=true});return function g(q,p,l){if(q.session){return l()}if(!h){return debug("store is disconnected"),l()}var m=parse(q.originalUrl).pathname;if(0!=m.indexOf(d.path||"/")){return l()}var j=c.secret||q.secret;if(!j){throw new Error("`secret` option required for sessions")}var t,i;q.sessionStore=b;var o=q.cookies[e];var n=q.signedCookies[e];if(!n&&o){n=(0==o.indexOf("s:"))?signature.unsign(o.slice(2),j):o}var s=p.writeHead;p.writeHead=function(){if(!q.session){debug("no session");s.apply(p,arguments);return}var v=q.session.cookie,w=(q.headers["x-forwarded-proto"]||"").split(",")[0].toLowerCase().trim(),y=q.connection.encrypted||(f&&"https"==w),u=n!=q.sessionID;if(v.secure&&!y){debug("not secured");s.apply(p,arguments);return}if(!a){if(null==v.expires){if(!u){debug("already set browser-session cookie");s.apply(p,arguments);return}}else{if(t==hash(q.session)&&i==q.session.id){debug("unmodified session");s.apply(p,arguments);return}}}var x="s:"+signature.sign(q.sessionID,j);x=v.serialize(e,x);debug("set-cookie %s",x);p.setHeader("Set-Cookie",x);s.apply(p,arguments)};var k=p.end;p.end=function(v,u){p.end=k;if(!q.session){return p.end(v,u)}debug("saving");q.session.resetMaxAge();q.session.save(function(w){if(w){console.error(w.stack)}debug("saved");p.end(v,u)})};function r(){b.generate(q)}q.sessionID=n;if(!q.sessionID){debug("no SID sent, generating session");r();l();return}debug("fetching %s",q.sessionID);b.get(q.sessionID,function(v,u){if(v){debug("error %j",v);if("ENOENT"==v.code){r();l()}else{l(v)}}else{if(!u){debug("no session found");r();l()}else{debug("session found");b.createSession(q,u);i=q.sessionID;t=hash(u);l()}}})}}function hash(a){return crc32.signed(JSON.stringify(a,function(b,c){if("cookie"!=b){return c}}))};