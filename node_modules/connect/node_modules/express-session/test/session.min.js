var connect=require("connect"),assert=require("assert"),request=require("supertest"),should=require("should"),cookieParser=require("cookie-parser"),session=require("../");var min=60*1000;function respond(b,a){a.end()}function sid(a){var b=a.headers["set-cookie"];if(!b){return""}return/^connect\.sid=([^;]+);/.exec(b[0])[1]}function expires(a){return a.headers["set-cookie"][0].match(/Expires=([^;]+)/)[1]}var app=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min}})).use(respond);describe("session()",function(){it("should export constructors",function(){session.Session.should.be.a.Function;session.Store.should.be.a.Function;session.MemoryStore.should.be.a.Function});describe("proxy option",function(){describe("when enabled",function(){it("should trust X-Forwarded-Proto when string",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",proxy:true,cookie:{secure:true,maxAge:5}})).use(respond);request(b).get("/").set("X-Forwarded-Proto","https").end(function(d,c){c.headers.should.have.property("set-cookie");a()})});it("should trust X-Forwarded-Proto when comma-separated list",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",proxy:true,cookie:{secure:true,maxAge:5}})).use(respond);request(b).get("/").set("X-Forwarded-Proto","https,http").end(function(d,c){c.headers.should.have.property("set-cookie");a()})})});describe("when disabled",function(){it("should not trust X-Forwarded-Proto",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{secure:true,maxAge:min}})).use(respond);request(b).get("/").set("X-Forwarded-Proto","https").end(function(d,c){c.headers.should.not.have.property("set-cookie");a()})})})});describe("key option",function(){it('should default to "connect.sid"',function(a){request(app).get("/").end(function(c,b){b.headers["set-cookie"].should.have.length(1);b.headers["set-cookie"][0].should.match(/^connect\.sid/);a()})});it("should allow overriding",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",key:"sid",cookie:{maxAge:min}})).use(respond);request(b).get("/").end(function(d,c){c.headers["set-cookie"].should.have.length(1);c.headers["set-cookie"][0].should.match(/^sid/);a()})})});it("should retain the sid",function(a){var c=0;var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min}})).use(function(e,d){e.session.count=++c;d.end()});request(b).get("/").end(function(e,d){var f=sid(d);request(b).get("/").set("Cookie","connect.sid="+f).end(function(h,g){sid(g).should.equal(f);a()})})});describe("when an invalid sid is given",function(){it("should generate a new one",function(a){request(app).get("/").set("Cookie","connect.sid=foobarbaz").end(function(c,b){sid(b).should.not.equal("foobarbaz");a()})})});it("should issue separate sids",function(a){var c=0;var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min}})).use(function(e,d){e.session.count=++c;d.end()});request(b).get("/").end(function(e,d){var f=sid(d);request(b).get("/").set("Cookie","connect.sid="+f).end(function(h,g){sid(g).should.equal(f);request(b).get("/").end(function(j,i){sid(i).should.not.equal(f);a()})})})});describe("req.session",function(){it("should persist",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min,httpOnly:false}})).use(function(e,c,d){e.session.cookie.httpOnly.should.equal(false);e.session.count=e.session.count||0;e.session.count++;c.end(e.session.count.toString())});request(b).get("/").end(function(d,c){c.text.should.equal("1");request(b).get("/").set("Cookie","connect.sid="+sid(c)).end(function(f,e){e.text.should.equal("2");a()})})});it("should only set-cookie when modified",function(a){var c=true;var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min}})).use(function(f,d,e){if(c){f.session.count=f.session.count||0;f.session.count++}d.end(f.session.count.toString())});request(b).get("/").end(function(e,d){d.text.should.equal("1");request(b).get("/").set("Cookie","connect.sid="+sid(d)).end(function(g,f){var h=sid(f);f.text.should.equal("2");c=false;request(b).get("/").set("Cookie","connect.sid="+sid(f)).end(function(j,i){sid(i).should.be.empty;i.text.should.equal("2");c=true;request(b).get("/").set("Cookie","connect.sid="+h).end(function(l,k){sid(k).should.not.be.empty;k.text.should.equal("3");a()})})})})});describe(".destroy()",function(){it("should destroy the previous session",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat"})).use(function(e,c,d){e.session.destroy(function(f){if(f){throw f}assert(!e.session,"req.session after destroy");c.end()})});request(b).get("/").end(function(d,c){c.headers.should.not.have.property("set-cookie");a()})})});describe(".regenerate()",function(){it("should destroy/replace the previous session",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:min}})).use(function(e,c,d){var f=e.session.id;e.session.regenerate(function(g){if(g){throw g}f.should.not.equal(e.session.id);c.end()})});request(b).get("/").end(function(d,c){var e=sid(c);request(b).get("/").set("Cookie","connect.sid="+e).end(function(g,f){sid(f).should.not.equal("");sid(f).should.not.equal(e);a()})})})});describe(".cookie",function(){describe(".*",function(){it("should serialize as parameters",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",proxy:true,cookie:{maxAge:min}})).use(function(e,c,d){e.session.cookie.httpOnly=false;e.session.cookie.secure=true;c.end()});request(b).get("/").set("X-Forwarded-Proto","https").end(function(d,c){c.headers["set-cookie"][0].should.not.include("HttpOnly");c.headers["set-cookie"][0].should.include("Secure");a()})});it("should default to a browser-session length cookie",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/admin"}})).use(function(e,c,d){c.end()});request(b).get("/admin").end(function(e,d){var c=d.headers["set-cookie"][0];c.should.not.include("Expires");a()})});it("should Set-Cookie only once for browser-session cookies",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/admin"}})).use(function(e,c,d){c.end()});request(b).get("/admin/foo").end(function(d,c){c.headers.should.have.property("set-cookie");request(b).get("/admin").set("Cookie","connect.sid="+sid(c)).end(function(f,e){e.headers.should.not.have.property("set-cookie");a()})})});it("should override defaults",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/admin",httpOnly:false,secure:true,maxAge:5000}})).use(function(e,c,d){e.session.cookie.secure=false;c.end()});request(b).get("/admin").end(function(e,d){var c=d.headers["set-cookie"][0];c.should.not.include("HttpOnly");c.should.not.include("Secure");c.should.include("Path=/admin");c.should.include("Expires");a()})})});describe(".secure",function(){it("should not set-cookie when insecure",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat"})).use(function(e,c,d){e.session.cookie.secure=true;c.end()});request(b).get("/").end(function(d,c){c.headers.should.not.have.property("set-cookie");a()})})});describe("when the pathname does not match cookie.path",function(){it("should not set-cookie",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/foo/bar"}})).use(function(e,c,d){if(!e.session){return c.end()}e.session.foo=Math.random();c.end()});request(b).get("/").end(function(d,c){c.status.should.equal(200);c.headers.should.not.have.property("set-cookie");a()})});it("should not set-cookie even for FQDN",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/foo/bar"}})).use(function(e,c,d){if(!e.session){return c.end()}e.session.foo=Math.random();c.end()});request(b).get("/").set("host","http://foo/bar").end(function(d,c){c.status.should.equal(200);c.headers.should.not.have.property("set-cookie");a()})})});describe("when the pathname does match cookie.path",function(){it("should set-cookie",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/foo/bar"}})).use(function(e,c,d){e.session.foo=Math.random();c.end()});request(b).get("/foo/bar/baz").end(function(d,c){c.headers.should.have.property("set-cookie");a()})});it("should set-cookie even for FQDN",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{path:"/foo/bar"}})).use(function(e,c,d){e.session.foo=Math.random();c.end()});request(b).get("/foo/bar/baz").set("host","http://example.com").end(function(d,c){c.status.should.equal(200);c.headers.should.have.property("set-cookie");a()})})});describe(".maxAge",function(){var b;var a=connect().use(cookieParser()).use(session({secret:"keyboard cat",cookie:{maxAge:2000}})).use(function(e,c,d){e.session.count=e.session.count||0;e.session.count++;if(e.session.count==2){e.session.cookie.maxAge=5000}if(e.session.count==3){e.session.cookie.maxAge=3000000000}c.end(e.session.count.toString())});it("should set relative in milliseconds",function(c){request(a).get("/").end(function(g,f){var e=new Date(expires(f)),d=new Date;b=sid(f);e.getYear().should.equal(d.getYear());e.getMonth().should.equal(d.getMonth());e.getDate().should.equal(d.getDate());e.getSeconds().should.not.equal(d.getSeconds());var h=e.valueOf()-d.valueOf();(h>1000&&h<2000).should.be.ok;f.text.should.equal("1");c()})});it("should modify cookie when changed",function(c){request(a).get("/").set("Cookie","connect.sid="+b).end(function(g,f){var e=new Date(expires(f)),d=new Date;b=sid(f);e.getYear().should.equal(d.getYear());e.getMonth().should.equal(d.getMonth());e.getSeconds().should.not.equal(d.getSeconds());var h=e.valueOf()-d.valueOf();(h>4000&&h<5000).should.be.ok;f.text.should.equal("2");c()})});it("should modify cookie when changed to large value",function(c){request(a).get("/").set("Cookie","connect.sid="+b).end(function(g,f){var e=new Date(expires(f)),d=new Date;b=sid(f);var h=e.valueOf()-d.valueOf();(h>2999999000&&h<3000000000).should.be.ok;f.text.should.equal("3");c()})})});describe(".expires",function(){describe("when given a Date",function(){it("should set absolute",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat"})).use(function(e,c,d){e.session.cookie.expires=new Date(0);c.end()});request(b).get("/").end(function(d,c){expires(c).should.equal("Thu, 01 Jan 1970 00:00:00 GMT");a()})})});describe("when null",function(){it("should be a browser-session cookie",function(a){var b=connect().use(cookieParser()).use(session({secret:"keyboard cat"})).use(function(e,c,d){e.session.cookie.expires=null;c.end()});request(b).get("/").end(function(d,c){c.headers["set-cookie"][0].should.not.include("Expires=");a()})})})})});it("should support req.signedCookies",function(a){var b=connect().use(cookieParser("keyboard cat")).use(session()).use(function(e,c,d){e.session.count=e.session.count||0;e.session.count++;c.end(e.session.count.toString())});request(b).get("/").end(function(d,c){c.text.should.equal("1");request(b).get("/").set("Cookie","connect.sid="+sid(c)).end(function(f,e){e.text.should.equal("2");a()})})})})});