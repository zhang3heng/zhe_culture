/*
 * Connect - csrf
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */
var uid=require("uid2");var crypto=require("crypto");var scmp=require("scmp");module.exports=function csrf(a){a=a||{};var b=a.value||defaultValue;return function(g,d,f){var c=g.session.csrfSecret;if(c){return e(c)}uid(24,function(i,h){if(i){return f(i)}g.session.csrfSecret=h;e(h)});function e(i){var j;g.csrfToken=function h(){return j||(j=saltedToken(i))};if("GET"==g.method||"HEAD"==g.method||"OPTIONS"==g.method){return f()}var l=b(g);if(!checkToken(l,i)){var k=new Error("invalid csrf token");k.status=403;f(k);return}f()}}};function defaultValue(a){return(a.body&&a.body._csrf)||(a.query&&a.query._csrf)||(a.headers["x-csrf-token"])||(a.headers["x-xsrf-token"])}function saltedToken(a){return createToken(generateSalt(10),a)}function createToken(b,a){return b+crypto.createHash("sha1").update(b+a).digest("base64")}function checkToken(b,a){if("string"!=typeof b){return false}return scmp(b,createToken(b.slice(0,10),a))}function generateSalt(c){var a,b=[];for(a=0;a<c;++a){b.push(SALTCHARS[Math.floor(Math.random()*SALTCHARS.length)])}return b.join("")}var SALTCHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";