/*
 * Connect - HTTPServer
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var http=require("http"),utils=require("./utils"),debug=require("debug")("connect:dispatcher");var app=module.exports={};var env=process.env.NODE_ENV||"development";app.use=function(a,b){if("string"!=typeof a){b=a;a="/"}if("function"==typeof b.handle){var c=b;b.route=a;b=function(f,d,e){c.handle(f,d,e)}}if(b instanceof http.Server){b=b.listeners("request")[0]}if("/"==a[a.length-1]){a=a.slice(0,-1)}debug("use %s %s",a||"/",b.name||"anonymous");this.stack.push({route:a,handle:b});return this};app.handle=function(j,h,b){var k=this.stack,l=1+j.url.indexOf("?"),i=l?l-1:j.url.length,c=1+j.url.substr(0,i).indexOf("://"),a=c?j.url.substr(0,j.url.indexOf("/",2+c)):"",g="",d=false,f=0;function e(n){var m,q,s;if(d){j.url=j.url.substr(1);d=false}j.url=a+g+j.url.substr(a.length);j.originalUrl=j.originalUrl||j.url;g="";m=k[f++];if(!m||h.headerSent){if(b){return b(n)}if(n){if(h.statusCode<400){h.statusCode=500}debug("default %s",h.statusCode);if(n.status){h.statusCode=n.status}var r="production"==env?http.STATUS_CODES[h.statusCode]:n.stack||n.toString();r=utils.escape(r);if("test"!=env){console.error(n.stack||n.toString())}if(h.headerSent){return j.socket.destroy()}h.setHeader("Content-Type","text/html");h.setHeader("Content-Length",Buffer.byteLength(r));if("HEAD"==j.method){return h.end()}h.end(r)}else{debug("default 404");h.statusCode=404;h.setHeader("Content-Type","text/html");if("HEAD"==j.method){return h.end()}h.end("Cannot "+utils.escape(j.method)+" "+utils.escape(j.originalUrl)+"\n")}return}try{q=utils.parseUrl(j).pathname;if(undefined==q){q="/"}if(0!=q.toLowerCase().indexOf(m.route.toLowerCase())){return e(n)}s=q[m.route.length];if(s&&"/"!=s&&"."!=s){return e(n)}g=m.route;j.url=a+j.url.substr(a.length+g.length);if(!c&&"/"!=j.url[0]){j.url="/"+j.url;d=true}debug("%s %s : %s",m.handle.name||"anonymous",m.route,j.originalUrl);var o=m.handle.length;if(n){if(o===4){m.handle(n,j,h,e)}else{e(n)}}else{if(o<4){m.handle(j,h,e)}else{e()}}}catch(p){e(p)}}e()};app.listen=function(){var a=http.createServer(this);return a.listen.apply(a,arguments)};