/*
 * Connect - json
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var utils=require("../utils");var getBody=require("raw-body");exports=module.exports=function(b){b=b||{};var a=b.strict!==false;var d=typeof b.verify==="function"&&b.verify;return function c(g,e,f){if(g._body){return f()}g.body=g.body||{};if(!utils.hasBody(g)){return f()}if(!exports.regexp.test(utils.mime(g))){return f()}g._body=true;getBody(g,{limit:b.limit||"1mb",length:g.headers["content-length"],encoding:"utf8"},function(i,h){if(i){return f(i)}if(d){try{d(g,e,h)}catch(i){if(!i.status){i.status=403}return f(i)}}var j=h.trim()[0];if(0==h.length){return f(utils.error(400,"invalid json, empty body"))}if(a&&"{"!=j&&"["!=j){return f(utils.error(400,"invalid json"))}try{g.body=JSON.parse(h,b.reviver)}catch(i){i.body=h;i.status=400;return f(i)}f()})}};exports.regexp=/^application\/([\w!#\$%&\*`\-\.\^~]*\+)?json$/i;