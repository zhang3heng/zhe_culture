/*
 * Connect - limit
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var utils=require("../utils"),brokenPause=utils.brokenPause;module.exports=function limit(b){if("string"==typeof b){b=utils.parseBytes(b)}if("number"!=typeof b){throw new Error("limit() bytes required")}if(process.env.NODE_ENV!=="test"){console.warn("connect.limit() will be removed in connect 3.0")}return function a(h,e,g){var i=0,c=h.headers["content-length"]?parseInt(h.headers["content-length"],10):null;if(h._limit){return g()}h._limit=true;if(c&&c>b){return g(utils.error(413))}if(brokenPause){d()}else{h.on("newListener",function f(j){if(j!=="data"){return}h.removeListener("newListener",f);process.nextTick(d)})}g();function d(){h.on("data",function(j){i+=Buffer.isBuffer(j)?j.length:Buffer.byteLength(j);if(i>b){h.destroy()}})}}};