/*
 * Connect - multipart
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */
var multiparty=require("multiparty"),_limit=require("./limit"),utils=require("../utils"),qs=require("qs");exports=module.exports=function(c){c=c||{};if(process.env.NODE_ENV!=="test"){console.warn("connect.multipart() will be removed in connect 3.0");console.warn("visit https://github.com/senchalabs/connect/wiki/Connect-3.0 for alternatives")}var a=_limit(c.limit||"100mb");return function b(f,d,e){if(f._body){return e()}f.body=f.body||{};f.files=f.files||{};if(!utils.hasBody(f)){return e()}if("GET"==f.method||"HEAD"==f.method){return e()}if("multipart/form-data"!=utils.mime(f)){return e()}f._body=true;a(f,d,function(j){if(j){return e(j)}var i=new multiparty.Form(c),k={},h={},g;Object.keys(c).forEach(function(m){i[m]=c[m]});function l(m,o,n){if(Array.isArray(n[m])){n[m].push(o)}else{if(n[m]){n[m]=[n[m],o]}else{n[m]=o}}}i.on("field",function(m,n){l(m,n,k)});if(!c.defer){i.on("file",function(m,n){n.name=n.originalFilename;n.type=n.headers["content-type"]||null;l(m,n,h)})}i.on("error",function(m){if(!c.defer){m.status=400;e(m)}g=true});i.on("close",function(){if(g){return}try{f.body=qs.parse(k);f.files=qs.parse(h)}catch(m){i.emit("error",m);return}if(!c.defer){e()}});i.parse(f);if(c.defer){f.form=i;e()}})}};