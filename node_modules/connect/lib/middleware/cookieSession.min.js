/*
 * Connect - cookieSession
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */
var utils=require("./../utils"),Cookie=require("express-session").Cookie,debug=require("debug")("connect:cookieSession"),signature=require("cookie-signature"),url=require("url");module.exports=function cookieSession(b){b=b||{};var c=b.key||"connect.sess",d=b.proxy;return function a(m,l,i){var h=b.secret||m.secret;if(!h){throw new Error("`secret` option required for cookie sessions")}m.session={};var e=m.session.cookie=new Cookie(b.cookie);var j=url.parse(m.originalUrl).pathname;if(0!=j.indexOf(e.path)){return i()}if(!b.secret&&m.secret){m.session=m.signedCookies[c]||{};m.session.cookie=e}else{var k=m.cookies[c];if(k){var g=utils.parseSignedCookie(k,h);if(g){var f=g;m.session=utils.parseJSONCookie(g)||{};m.session.cookie=e}}}l.on("header",function(){if(!m.session){debug("clear session");e.expires=new Date(0);l.setHeader("Set-Cookie",e.serialize(c,""));return}delete m.session.cookie;var n=(m.headers["x-forwarded-proto"]||"").toLowerCase(),p=m.connection.encrypted||(d&&"https"==n.split(/\s*,\s*/)[0]);if(e.secure&&!p){return debug("not secured")}debug("serializing %j",m.session);var o="j:"+JSON.stringify(m.session);if(f==o){return debug("unmodified session")}o="s:"+signature.sign(o,h);o=e.serialize(c,o);debug("set-cookie %j",e);l.setHeader("Set-Cookie",o)});i()}};