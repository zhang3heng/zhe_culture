/*
 * Connect - staticCache
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */
var utils=require("../utils"),Cache=require("../cache"),fresh=require("fresh");module.exports=function staticCache(c){var c=c||{},a=new Cache(c.maxObjects||128),d=c.maxLength||1024*256;if(process.env.NODE_ENV!=="test"){console.warn("connect.staticCache() is deprecated and will be removed in 3.0");console.warn("use varnish or similar reverse proxy caches.")}return function b(j,h,i){var g=cacheKey(j),f=j.headers.range,e=j.headers.cookie,k=a.get(g);j.on("static",function(p){var o=h._headers,q=utils.parseCacheControl(o["cache-control"]||""),m=o["content-length"],n;if(o["set-cookie"]){return e=true}if(e){return}if(!m||m>d){return}if(o["content-range"]){return}if(q["no-cache"]||q["no-store"]||q["private"]||q["must-revalidate"]){return}if(n=a.get(g)){if(o.etag==n[0].etag){n[0].date=new Date;return}else{a.remove(g)}}if(null==p){return}var l=[];p.on("data",function(r){l.push(r)});p.on("end",function(){var r=a.add(g);delete o["x-cache"];r.push(200);r.push(o);r.push.apply(r,l)})});if(j.method=="GET"||j.method=="HEAD"){if(f){i()}else{if(!e&&k&&!mustRevalidate(j,k)){h.setHeader("X-Cache","HIT");respondFromCache(j,h,k)}else{h.setHeader("X-Cache","MISS");i()}}}else{i()}}};function respondFromCache(e,b,g){var a=g[0],f=utils.merge({},g[1]),d=g.slice(2);f.age=(new Date-new Date(f.date))/1000||0;switch(e.method){case"HEAD":b.writeHead(a,f);b.end();break;case"GET":if(utils.conditionalGET(e)&&fresh(e.headers,f)){f["content-length"]=0;b.writeHead(304,f);b.end()}else{b.writeHead(a,f);function c(){while(d.length){if(false===b.write(d.shift())){b.once("drain",c);return}}b.end()}c()}break;default:b.writeHead(500,"");b.end()}}function mustRevalidate(c,f){var a=f[1],b=utils.parseCacheControl(c.headers["cache-control"]||""),e=utils.parseCacheControl(a["cache-control"]||""),d=(new Date-new Date(a.date))/1000||0;if(e["no-cache"]||e["must-revalidate"]||e["proxy-revalidate"]){return true}if(b["no-cache"]){return true}if(null!=b["max-age"]){return b["max-age"]<d}if(null!=e["max-age"]){return e["max-age"]<d}return false}function cacheKey(a){return utils.parseUrl(a).path};