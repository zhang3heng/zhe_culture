var fs=require("fs"),mysql=require("mysql"),path=require("path"),inspect=require("util").inspect,os=require("os"),Busboy=require("busboy"),UPLOAD_DIR="./upload/";var pool=mysql.createPool({host:"localhost",database:"zhe",port:"3306",user:"root",password:""});work={name:"",content:"",author:"",uploader:"",uploadDate:"",comment:"",workFile:"",classify:""};exports.upload=function(d,c){var b=new Busboy({headers:d.headers});var a=null;b.on("file",function(g,h,f,i,e){fs.exists(UPLOAD_DIR,function(j){if(!j){fs.mkdir(UPLOAD_DIR)}var k=path.join(UPLOAD_DIR,f);a=k;h.pipe(fs.createWriteStream(k))});h.on("data",function(j){console.log("已上传："+j.length)});h.on("end",function(j){console.log("上传完成");work[g]=UPLOAD_DIR+f})});b.on("field",function(e,f){work[e]=f});b.on("finish",function(){console.log(work);var e=false;pool.getConnection(function(f,g){if(f){return}var h="insert into work set ?";g.query(h,work,function(j,i){if(j){console.log(j);return}if(i.affectedRows){e=true;c.json(e)}g.release()})})});return d.pipe(b)};exports.work_item=function(c,b){var a={};var d=c.query.itemId;pool.getConnection(function(e,f){if(e){console.log(e);b.send(500,"数据库连接失败");return}var g="select * from work where id=?";f.query(g,[d],function(h,i){work=i[0]});console.log(work);b.render("work_item",{work:work});f.release()})};